{% load static %}
{% include "header.html" %}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Order Management - TakaHub Admin</title>
    <link rel="stylesheet" href="{% static 'css/buyer_profile.css' %}">
    <style>
        .order-management-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-card h4 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #1A7836;
        }

        .orders-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .orders-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .orders-table th,
        .orders-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .orders-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .payment-pending {
            background-color: #fff3cd;
            color: #856404;
        }

        .payment-paid {
            background-color: #d4edda;
            color: #155724;
        }

        .delivery-ready {
            background-color: #cce5ff;
            color: #004085;
        }

        .delivery-packed {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .delivery-on_the_way {
            background-color: #d4edda;
            color: #155724;
        }

        .delivery-delivered {
            background-color: #d4edda;
            color: #155724;
        }

        .delivery-returned, .delivery-cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-view {
            background-color: #007bff;
            color: white;
        }

        .btn-update {
            background-color: #28a745;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .pagination a,
        .pagination span {
            padding: 8px 12px;
            margin: 0 2px;
            border: 1px solid #ddd;
            text-decoration: none;
            color: #333;
            border-radius: 4px;
        }

        .pagination .current {
            background-color: #1A7836;
            color: white;
            border-color: #1A7836;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filters select,
        .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .filters label {
            font-weight: 500;
            margin-right: 5px;
        }
    </style>
</head>
<body>

<section class="product-banner">
    <h2>Order Management</h2>
    <p><a href="/admin-dashboard/">Admin Dashboard</a> > Order Management</p>
</section>

<div class="order-management-container">
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <h4>Total Orders</h4>
            <div class="stat-number">{{ total_orders }}</div>
        </div>
        <div class="stat-card">
            <h4>Pending Payment</h4>
            <div class="stat-number">{{ pending_orders }}</div>
        </div>
        <div class="stat-card">
            <h4>Paid Orders</h4>
            <div class="stat-number">{{ paid_orders }}</div>
        </div>
        <div class="stat-card">
            <h4>Completed Orders</h4>
            <div class="stat-number">{{ completed_orders }}</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="filters">
        <label for="payment_filter">Payment Status:</label>
        <select id="payment_filter" onchange="filterOrders()">
            <option value="">All</option>
            <option value="pending">Pending</option>
            <option value="paid">Paid</option>
        </select>

        <label for="delivery_filter">Delivery Status:</label>
        <select id="delivery_filter" onchange="filterOrders()">
            <option value="">All</option>
            <option value="ready">Ready</option>
            <option value="packed">Packed</option>
            <option value="on_the_way">On the Way</option>
            <option value="delivered">Delivered</option>
            <option value="returned">Returned</option>
            <option value="cancelled">Cancelled</option>
        </select>

        <label for="search">Search:</label>
        <input type="text" id="search" placeholder="Order ID or Buyer name" onkeyup="filterOrders()">
    </div>

    <!-- Orders Table -->
    <div class="orders-table">
        <table id="ordersTable">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Buyer</th>
                    <th>Total Amount</th>
                    <th>Payment Status</th>
                    <th>Delivery Status</th>
                    <th>Driver</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in page_obj %}
                    <tr>
                        <td>#{{ order.id }}</td>
                        <td>{{ order.buyer.name|default:order.buyer.username }}</td>
                        <td>KSh {{ order.total_amount|floatformat:0 }}</td>
                        <td>
                            <span class="status-badge payment-{{ order.payment_status }}">
                                {{ order.payment_status|title }}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge delivery-{{ order.delivery_status|lower }}">
                                {{ order.delivery_status|title|truncatechars:12 }}
                            </span>
                        </td>
                        <td>
                            {% if order.assigned_delivery_guy %}
                                {{ order.assigned_delivery_guy.name|default:order.assigned_delivery_guy.username }}
                            {% else %}
                                <em>Unassigned</em>
                            {% endif %}
                        </td>
                        <td>{{ order.created_at|date:"M d, Y H:i" }}</td>
                        <td>
                            <a href="{% url 'admin_order_detail' order.id %}" class="action-btn btn-view">View</a>
                            <a href="{% url 'admin_update_order_status' order.id %}" class="action-btn btn-update">Update</a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page={{ page_obj.previous_page_number }}">« Previous</a>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                    <span class="current">{{ num }}</span>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <a href="?page={{ num }}">{{ num }}</a>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}">Next »</a>
            {% endif %}
        </div>
    {% endif %}
</div>

<script>
function filterOrders() {
    const paymentFilter = document.getElementById('payment_filter').value.toLowerCase();
    const deliveryFilter = document.getElementById('delivery_filter').value.toLowerCase();
    const searchTerm = document.getElementById('search').value.toLowerCase();
    const table = document.getElementById('ordersTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName('td');
        const paymentStatus = cells[3].textContent.toLowerCase().trim();
        const deliveryStatus = cells[4].textContent.toLowerCase().trim();
        const orderId = cells[0].textContent.toLowerCase();
        const buyerName = cells[1].textContent.toLowerCase();

        const matchesPayment = !paymentFilter || paymentStatus.includes(paymentFilter);
        const matchesDelivery = !deliveryFilter || deliveryStatus.includes(deliveryFilter);
        const matchesSearch = !searchTerm ||
            orderId.includes(searchTerm) ||
            buyerName.includes(searchTerm);

        if (matchesPayment && matchesDelivery && matchesSearch) {
            rows[i].style.display = '';
        } else {
            rows[i].style.display = 'none';
        }
    }
}
</script>

</body>
</html>
{% include "footer.html" %}